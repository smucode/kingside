var require=function(a,b){var c=require.resolve(a,b||"/"),d=require.modules[c];if(!d)throw new Error("Failed to resolve module "+a+", tried "+c);var e=d._cached?d._cached:d();return e};require.paths=[],require.modules={},require.extensions=[".js",".coffee"],require._core={assert:!0,events:!0,fs:!0,path:!0,vm:!0},require.resolve=function(){return function(a,b){function g(a){if(require.modules[a])return a;for(var b=0;b<require.extensions.length;b++){var c=require.extensions[b];if(require.modules[a+c])return a+c}}function h(a){a=a.replace(/\/+$/,"");var b=a+"/package.json";if(require.modules[b]){var d=require.modules[b](),e=d.browserify;if(typeof e=="object"&&e.main){var f=g(c.resolve(a,e.main));if(f)return f}else if(typeof e=="string"){var f=g(c.resolve(a,e));if(f)return f}else if(d.main){var f=g(c.resolve(a,d.main));if(f)return f}}return g(a+"/index")}function i(a,b){var c=j(b);for(var d=0;d<c.length;d++){var e=c[d],f=g(e+"/"+a);if(f)return f;var i=h(e+"/"+a);if(i)return i}var f=g(a);if(f)return f}function j(a){var b;a==="/"?b=[""]:b=c.normalize(a).split("/");var d=[];for(var e=b.length-1;e>=0;e--){if(b[e]==="node_modules")continue;var f=b.slice(0,e+1).join("/")+"/node_modules";d.push(f)}return d}b||(b="/");if(require._core[a])return a;var c=require.modules.path(),d=b||".";if(a.match(/^(?:\.\.?\/|\/)/)){var e=g(c.resolve(d,a))||h(c.resolve(d,a));if(e)return e}var f=i(a,d);if(f)return f;throw new Error("Cannot find module '"+a+"'")}}(),require.alias=function(a,b){var c=require.modules.path(),d=null;try{d=require.resolve(a+"/package.json","/")}catch(e){d=require.resolve(a,"/")}var f=c.dirname(d),g=Object_keys(require.modules);for(var h=0;h<g.length;h++){var i=g[h];if(i.slice(0,f.length+1)===f+"/"){var j=i.slice(f.length);require.modules[b+j]=require.modules[f+j]}else i===f&&(require.modules[b]=require.modules[f])}},require.define=function(a,b){var c=require._core[a]?"":require.modules.path().dirname(a),d=function(a){return require(a,c)};d.resolve=function(a){return require.resolve(a,c)},d.modules=require.modules,d.define=require.define;var e={exports:{}};require.modules[a]=function(){return require.modules[a]._cached=e.exports,b.call(e.exports,d,e,e.exports,c,a),require.modules[a]._cached=e.exports,e.exports}};var Object_keys=Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b};typeof process=="undefined"&&(process={}),process.nextTick||(process.nextTick=function(a){setTimeout(a,0)}),process.title||(process.title="browser"),process.binding||(process.binding=function(a){if(a==="evals")return require("vm");throw new Error("No such module")}),process.cwd||(process.cwd=function(){return"."}),require.define("path",function(a,b,c,d,e){function f(a,b){var c=[];for(var d=0;d<a.length;d++)b(a[d],d,a)&&c.push(a[d]);return c}function g(a,b){var c=0;for(var d=a.length;d>=0;d--){var e=a[d];e=="."?a.splice(d,1):e===".."?(a.splice(d,1),c++):c&&(a.splice(d,1),c--)}if(b)for(;c--;c)a.unshift("..");return a}var h=/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/;c.resolve=function(){var a="",b=!1;for(var c=arguments.length;c>=-1&&!b;c--){var d=c>=0?arguments[c]:process.cwd();if(typeof d!="string"||!d)continue;a=d+"/"+a,b=d.charAt(0)==="/"}return a=g(f(a.split("/"),function(a){return!!a}),!b).join("/"),(b?"/":"")+a||"."},c.normalize=function(a){var b=a.charAt(0)==="/",c=a.slice(-1)==="/";return a=g(f(a.split("/"),function(a){return!!a}),!b).join("/"),!a&&!b&&(a="."),a&&c&&(a+="/"),(b?"/":"")+a},c.join=function(){var a=Array.prototype.slice.call(arguments,0);return c.normalize(f(a,function(a,b){return a&&typeof a=="string"}).join("/"))},c.dirname=function(a){var b=h.exec(a)[1]||"",c=!1;return b?b.length===1||c&&b.length<=3&&b.charAt(1)===":"?b:b.substring(0,b.length-1):"."},c.basename=function(a,b){var c=h.exec(a)[2]||"";return b&&c.substr(-1*b.length)===b&&(c=c.substr(0,c.length-b.length)),c},c.extname=function(a){return h.exec(a)[3]||""}}),require.define("/node_modules/underscore/package.json",function(a,b,c,d,e){b.exports={main:"underscore.js"}}),require.define("/node_modules/underscore/underscore.js",function(a,b,c,d,e){((function(){function D(a,b,c){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual&&z.isFunction(a.isEqual))return a.isEqual(b);if(b.isEqual&&z.isFunction(b.isEqual))return b.isEqual(a);var d=l.call(a);if(d!=l.call(b))return!1;switch(d){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;var e=c.length;while(e--)if(c[e]==a)return!0;c.push(a);var f=0,g=!0;if(d=="[object Array]"){f=a.length,g=f==b.length;if(g)while(f--)if(!(g=f in a==f in b&&D(a[f],b[f],c)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(var h in a)if(m.call(a,h)){f++;if(!(g=m.call(b,h)&&D(a[h],b[h],c)))break}if(g){for(h in b)if(m.call(b,h)&&!(f--))break;g=!f}}return c.pop(),g}var a=this,d=a._,e={},f=Array.prototype,g=Object.prototype,h=Function.prototype,i=f.slice,j=f.concat,k=f.unshift,l=g.toString,m=g.hasOwnProperty,n=f.forEach,o=f.map,p=f.reduce,q=f.reduceRight,r=f.filter,s=f.every,t=f.some,u=f.indexOf,v=f.lastIndexOf,w=Array.isArray,x=Object.keys,y=h.bind,z=function(a){return new F(a)};typeof c!="undefined"?(typeof b!="undefined"&&b.exports&&(c=b.exports=z),c._=z):typeof define=="function"&&define.amd?define("underscore",function(){return z}):a._=z,z.VERSION="1.2.3";var A=z.each=z.forEach=function(a,b,c){if(a==null)return;if(n&&a.forEach===n)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,f=a.length;d<f;d++)if(d in a&&b.call(c,a[d],d,a)===e)return}else for(var g in a)if(m.call(a,g)&&b.call(c,a[g],g,a)===e)return};z.map=function(a,b,c){var d=[];return a==null?d:o&&a.map===o?a.map(b,c):(A(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),d)},z.reduce=z.foldl=z.inject=function(a,b,c,d){var e=arguments.length>2;a==null&&(a=[]);if(p&&a.reduce===p)return d&&(b=z.bind(b,d)),e?a.reduce(b,c):a.reduce(b);A(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},z.reduceRight=z.foldr=function(a,b,c,d){var e=arguments.length>2;a==null&&(a=[]);if(q&&a.reduceRight===q)return d&&(b=z.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=z.toArray(a).reverse();return d&&!e&&(b=z.bind(b,d)),e?z.reduce(f,b,c,d):z.reduce(f,b)},z.find=z.detect=function(a,b,c){var d;return B(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0}),d},z.filter=z.select=function(a,b,c){var d=[];return a==null?d:r&&a.filter===r?a.filter(b,c):(A(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},z.reject=function(a,b,c){var d=[];return a==null?d:(A(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)}),d)},z.every=z.all=function(a,b,c){var d=!0;return a==null?d:s&&a.every===s?a.every(b,c):(A(a,function(a,f,g){if(!(d=d&&b.call(c,a,f,g)))return e}),d)};var B=z.some=z.any=function(a,b,c){b||(b=z.identity);var d=!1;return a==null?d:t&&a.some===t?a.some(b,c):(A(a,function(a,f,g){if(d||(d=b.call(c,a,f,g)))return e}),!!d)};z.include=z.contains=function(a,b){var c=!1;return a==null?c:u&&a.indexOf===u?a.indexOf(b)!=-1:(c=B(a,function(a){return a===b}),c)},z.invoke=function(a,b){var c=i.call(arguments,2);return z.map(a,function(a){return(b.call?b||a:a[b]).apply(a,c)})},z.pluck=function(a,b){return z.map(a,function(a){return a[b]})},z.max=function(a,b,c){if(!b&&z.isArray(a))return Math.max.apply(Math,a);if(!b&&z.isEmpty(a))return-Infinity;var d={computed:-Infinity};return A(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},z.min=function(a,b,c){if(!b&&z.isArray(a))return Math.min.apply(Math,a);if(!b&&z.isEmpty(a))return Infinity;var d={computed:Infinity};return A(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})}),d.value},z.shuffle=function(a){var b=[],c;return A(a,function(a,d,e){d==0?b[0]=a:(c=Math.floor(Math.random()*(d+1)),b[d]=b[c],b[c]=a)}),b},z.sortBy=function(a,b,c){return z.pluck(z.map(a,function(a,d,e){return{value:a,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c<d?-1:c>d?1:0}),"value")},z.groupBy=function(a,b){var c={},d=z.isFunction(b)?b:function(a){return a[b]};return A(a,function(a,b){var e=d(a,b);(c[e]||(c[e]=[])).push(a)}),c},z.sortedIndex=function(a,b,c){c||(c=z.identity);var d=0,e=a.length;while(d<e){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},z.toArray=function(a){return a?a.toArray?a.toArray():z.isArray(a)?i.call(a):z.isArguments(a)?i.call(a):z.values(a):[]},z.size=function(a){return z.toArray(a).length},z.first=z.head=function(a,b,c){return b!=null&&!c?i.call(a,0,b):a[0]},z.initial=function(a,b,c){return i.call(a,0,a.length-(b==null||c?1:b))},z.last=function(a,b,c){return b!=null&&!c?i.call(a,Math.max(a.length-b,0)):a[a.length-1]},z.rest=z.tail=function(a,b,c){return i.call(a,b==null||c?1:b)},z.compact=function(a){return z.filter(a,function(a){return!!a})},z.flatten=function(a,b){return z.reduce(a,function(a,c){return z.isArray(c)?a.concat(b?c:z.flatten(c)):(a[a.length]=c,a)},[])},z.without=function(a){return z.difference(a,i.call(arguments,1))},z.uniq=z.unique=function(a,b,c){var d=c?z.map(a,c):a,e=[];return z.reduce(d,function(c,d,f){if(0==f||(b===!0?z.last(c)!=d:!z.include(c,d)))c[c.length]=d,e[e.length]=a[f];return c},[]),e},z.union=function(){return z.uniq(z.flatten(arguments,!0))},z.intersection=z.intersect=function(a){var b=i.call(arguments,1);return z.filter(z.uniq(a),function(a){return z.every(b,function(b){return z.indexOf(b,a)>=0})})},z.difference=function(a){var b=z.flatten(i.call(arguments,1));return z.filter(a,function(a){return!z.include(b,a)})},z.zip=function(){var a=i.call(arguments),b=z.max(z.pluck(a,"length")),c=new Array(b);for(var d=0;d<b;d++)c[d]=z.pluck(a,""+d);return c},z.indexOf=function(a,b,c){if(a==null)return-1;var d,e;if(c)return d=z.sortedIndex(a,b),a[d]===b?d:-1;if(u&&a.indexOf===u)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1},z.lastIndexOf=function(a,b){if(a==null)return-1;if(v&&a.lastIndexOf===v)return a.lastIndexOf(b);var c=a.length;while(c--)if(c in a&&a[c]===b)return c;return-1},z.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);while(e<d)f[e++]=a,a+=c;return f};var C=function(){};z.bind=function(b,c){var d,e;if(b.bind===y&&y)return y.apply(b,i.call(arguments,1));if(!z.isFunction(b))throw new TypeError;return e=i.call(arguments,2),d=function(){if(this instanceof d){C.prototype=b.prototype;var a=new C,f=b.apply(a,e.concat(i.call(arguments)));return Object(f)===f?f:a}return b.apply(c,e.concat(i.call(arguments)))}},z.bindAll=function(a){var b=i.call(arguments,1);return b.length==0&&(b=z.functions(a)),A(b,function(b){a[b]=z.bind(a[b],a)}),a},z.memoize=function(a,b){var c={};return b||(b=z.identity),function(){var d=b.apply(this,arguments);return m.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}},z.delay=function(a,b){var c=i.call(arguments,2);return setTimeout(function(){return a.apply(a,c)},b)},z.defer=function(a){return z.delay.apply(z,[a,1].concat(i.call(arguments,1)))},z.throttle=function(a,b){var c,d,e,f,g,h=z.debounce(function(){g=f=!1},b);return function(){c=this,d=arguments;var i=function(){e=null,g&&a.apply(c,d),h()};e||(e=setTimeout(i,b)),f?g=!0:a.apply(c,d),h(),f=!0}},z.debounce=function(a,b){var c;return function(){var d=this,e=arguments,f=function(){c=null,a.apply(d,e)};clearTimeout(c),c=setTimeout(f,b)}},z.once=function(a){var b=!1,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments))}},z.wrap=function(a,b){return function(){var c=j.apply([a],arguments);return b.apply(this,c)}},z.compose=function(){var a=arguments;return function(){var b=arguments;for(var c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},z.after=function(a,b){return a<=0?b():function(){if(--a<1)return b.apply(this,arguments)}},z.keys=x||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)m.call(a,c)&&(b[b.length]=c);return b},z.values=function(a){return z.map(a,z.identity)},z.functions=z.methods=function(a){var b=[];for(var c in a)z.isFunction(a[c])&&b.push(c);return b.sort()},z.extend=function(a){return A(i.call(arguments,1),function(b){for(var c in b)b[c]!==void 0&&(a[c]=b[c])}),a},z.defaults=function(a){return A(i.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])}),a},z.clone=function(a){return z.isObject(a)?z.isArray(a)?a.slice():z.extend({},a):a},z.tap=function(a,b){return b(a),a},z.isEqual=function(a,b){return D(a,b,[])},z.isEmpty=function(a){if(z.isArray(a)||z.isString(a))return a.length===0;for(var b in a)if(m.call(a,b))return!1;return!0},z.isElement=function(a){return!!a&&a.nodeType==1},z.isArray=w||function(a){return l.call(a)=="[object Array]"},z.isObject=function(a){return a===Object(a)},z.isArguments=function(a){return l.call(a)=="[object Arguments]"},z.isArguments(arguments)||(z.isArguments=function(a){return!!a&&!!m.call(a,"callee")}),z.isFunction=function(a){return l.call(a)=="[object Function]"},z.isString=function(a){return l.call(a)=="[object String]"},z.isNumber=function(a){return l.call(a)=="[object Number]"},z.isNaN=function(a){return a!==a},z.isBoolean=function(a){return a===!0||a===!1||l.call(a)=="[object Boolean]"},z.isDate=function(a){return l.call(a)=="[object Date]"},z.isRegExp=function(a){return l.call(a)=="[object RegExp]"},z.isNull=function(a){return a===null},z.isUndefined=function(a){return a===void 0},z.noConflict=function(){return a._=d,this},z.identity=function(a){return a},z.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},z.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},z.mixin=function(a){A(z.functions(a),function(b){H(b,z[b]=a[b])})};var E=0;z.uniqueId=function(a){var b=E++;return a?a+b:b},z.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},z.template=function(a,b){var c=z.templateSettings,d="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.escape,function(a,b){return"',_.escape("+b.replace(/\\'/g,"'")+"),'"}).replace(c.interpolate,function(a,b){return"',"+b.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(a,b){return"');"+b.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+";__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');",e=new Function("obj","_",d);return b?e(b,z):function(a){return e.call(this,a,z)}};var F=function(a){this._wrapped=a};z.prototype=F.prototype;var G=function(a,b){return b?z(a).chain():a},H=function(a,b){F.prototype[a]=function(){var a=i.call(arguments);return k.call(a,this._wrapped),G(b.apply(z,a),this._chain)}};z.mixin(z),A(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=f[a];F.prototype[a]=function(){return b.apply(this._wrapped,arguments),G(this._wrapped,this._chain)}}),A(["concat","join","slice"],function(a){var b=f[a];F.prototype[a]=function(){return G(b.apply(this._wrapped,arguments),this._chain)}}),F.prototype.chain=function(){return this._chain=!0,this},F.prototype.value=function(){return this._wrapped}})).call(this)}),require.define("/Fen.js",function(a,b,c,d,e){var f=a("underscore"),g=function(a){this.pieces={},this.activeColor=null,this._parse(a||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")};g.prototype.move=function(a,b){this._validateMove(a,b),this._updateActiveColor(),this._updateCastling(a),this._updateEnPassant(a,b),this._updateHalfmoveClock(a,b),this._updateFullmoveNumber(),this._updatePiecePlacement(a,b)},g.prototype.canCastle=function(a){return f.include(this.castling,a)},g.prototype._validateMove=function(a,b){var c=this.pieces[a];if(!c)throw new Error("You must select a valid piece to move: "+a)},g.prototype._updateFullmoveNumber=function(){this.activeColor=="w"&&this.fullmove++},g.prototype._updateHalfmoveClock=function(a,b){var c=this.pieces[a];this._isPawn(c)||this.pieces[b]?this.halfmove=0:this.halfmove++},g.prototype._updateEnPassant=function(a,b){var c=this.pieces[a];if(this._isPawn(c)){var d=b.charAt(1)-a.charAt(1);if(Math.abs(d)==2){this.enPassant=b.charAt(0)+(parseInt(a.charAt(1),10)+d/2);return}}this.enPassant="-"},g.prototype._updateCastling=function(a){if(!this.castling.length)return!1;switch(a){case"a1":this.castling=f.without(this.castling,"Q");break;case"a8":this.castling=f.without(this.castling,"q");break;case"h1":this.castling=f.without(this.castling,"K");break;case"h8":this.castling=f.without(this.castling,"k");break;case"e1":this.castling=f.without(this.castling,"Q","K");break;case"e8":this.castling=f.without(this.castling,"q","k")}},g.prototype._updatePiecePlacement=function(a,b){var c=this.pieces[a];delete this.pieces[a],this.pieces[b]=c},g.prototype._updateActiveColor=function(){this.activeColor=this.activeColor=="w"?"b":"w"},g.prototype._isPawn=function(a){return a=="p"||a=="P"},g.prototype._parse=function(a){var b=a.split?a.split(" "):[];if(!b||b.length!=6)throw new Error("A FEN must contain 6 space separated fields: "+a);this._parsePiecePlacement(b[0]),this._parseActiveColor(b[1]),this._parseCastling(b[2]),this._parseEnPassant(b[3]),this._parseHalfmoveClock(b[4]),this._parseFullmoveNumber(b[5])},g.prototype._parsePiecePlacement=function(a){var b=a.split("/");if(b.length!=8)throw new Error("A FEN must contain 8 ranks separated by /: "+a);var c="abcdefgh",d="87654321";f.each(b,function(a,b){var e=0;f.each(a.split(""),function(a,f){if(!a.match(/[0-8]/)){var g=c.charAt(e)+d.charAt(b);this.pieces[g]=a,e++}else e+=parseInt(a,10)},this)},this)},g.prototype._parseActiveColor=function(a){if(a=="w"||a=="b")this.activeColor=a;else throw new Exception("Illegal active color: "+a)},g.prototype._parseCastling=function(a){if(a.match(/[wqWQ\-].*/))this.castling=a.split("");else throw new Exception("Illegal castling string: "+a)},g.prototype._parseEnPassant=function(a){this.enPassant=a},g.prototype._parseHalfmoveClock=function(a){this.halfmove=parseInt(a,10)},g.prototype._parseFullmoveNumber=function(a){this.fullmove=parseInt(a,10)},c.Fen=g}),require.define("/PieceFactory.js",function(a,b,c,d,e){var f=a("./Pawn").Pawn,g=a("./King").King,h=a("./Rook").Rook,i=a("./Knight").Knight,j=a("./Bishop").Bishop,k=a("./Queen").Queen,l={PAWN:1,KNIGHT:2,KING:3,BISHOP:5,ROOK:6,QUEEN:7,WHITE:1,BLACK:-1},m=function(){var a=[null,f,i,g,null,j,h,k],b={r:l.BLACK*l.ROOK,n:l.BLACK*l.KNIGHT,b:l.BLACK*l.BISHOP,q:l.BLACK*l.QUEEN,k:l.BLACK*l.KING,p:l.BLACK*l.PAWN,R:l.WHITE*l.ROOK,N:l.WHITE*l.KNIGHT,B:l.WHITE*l.BISHOP,Q:l.WHITE*l.QUEEN,K:l.WHITE*l.KING,P:l.WHITE*l.PAWN};return{create:function(c,d,e){var f=b[c],g=f>0?l.WHITE:l.BLACK,h=a[Math.abs(f)];return h?new h(d,g,e):{}}}}();c.PieceFactory=m}),require.define("/Pawn.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Piece").Piece,h=function(a,b,c){this.idx=a,this.color=b,this.board=c,this.moves=[],this.type=1};h.prototype=new g,h.prototype.calculate=function(){this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this.behindKing=null,this._addRegularMoves(),this._addCaptureMoves(),this._removePinnedMoves(),this._removeMovesNotHelpingCheckedKing()},h.prototype.canCaptureEnPassant=function(a){return this.board.isEnPassant(a)},h.prototype._addRegularMoves=function(){var a=this.idx+this.color*16;if(this.board.isOnBoard(a)&&this.board.isEmpty(a)){this.moves.push(a);if(this.color==1&&this.idx>=16&&this.idx<24||this.color==-1&&this.idx>=96&&this.idx<104)a=this.idx+this.color*32,this.board.isEmpty(a)&&this.moves.push(a)}},h.prototype._addCaptureMoves=function(){f.each(this._CAPTURE_DIRECTIONS,function(a){var b=this.idx+this.color*16+a;(this.canCapture(b)||this.canCaptureEnPassant(b))&&this.moves.push(b);if(this.canCapture(b)){var c=this.board._getPieceAt(b);c.color!=this.color&&c.type==3&&(this.checks=[this.idx])}this.board.isOnBoard(b)&&this.attacks.push(b)},this)},h.prototype._CAPTURE_DIRECTIONS=[1,-1],c.Pawn=h}),require.define("/Piece.js",function(a,b,c,d,e){var f=a("underscore"),g=function(){this.attacks=[]};g.prototype.canCapture=function(a){var b=this.board._getPieceAt(a);return b&&b.color!=this.color},g.prototype.canMoveTo=function(a){var b=this.board._getPieceAt(a);return!b&&this.board.isOnBoard(a)},g.prototype.addDirectionalMoves=function(a){this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this.behindKing=null,f.each(a,function(a){this._addNextDirectionalMove(a)},this),this._removePinnedMoves(),this._removeMovesNotHelpingCheckedKing()},g.prototype._removePinnedMoves=function(){if(this.color==this.board._getCurrentColor()){var a=this.board.isPinned(this.idx);a&&(this.moves=f.intersect(this.moves,a))}},g.prototype._addNextDirectionalMove=function(a,b){b=b||1;var c=this.idx+b*a;this.canMoveTo(c)?(this.moves.push(c),this.attacks.push(c),this._addNextDirectionalMove(a,++b)):(this.canCapture(c)&&(this.moves.push(c),this._checkPinning(c,a,b),this._checkKingAttacks(c,a,b)),this.board.isOnBoard(c)&&this.attacks.push(c))},g.prototype._removeMovesNotHelpingCheckedKing=function(){if(this.color==this.board._getCurrentColor()){var a=this.board.getCheckingPieces();a.length==1?this.moves=f.intersect(this.moves,a[0].checks):a.length>1&&(this.moves=[])}},g.prototype._checkKingAttacks=function(a,b,c){var d=this.board._getPieceAt(a);d.type==3&&(this.checks=[],this._setMoveBehindKing(b,c),this._backtrackPinnedMoves(b,--c,this.checks))},g.prototype._checkPinning=function(a,b,c){var d=this.idx+(c+1)*b;if(this.canMoveTo(d))this._checkPinning(a,b,++c);else if(this.canCapture(d)){var e=this.board._getPieceAt(d);e.type==3&&e.color!=this.color&&(this.pinning[a]=[],this._backtrackPinnedMoves(b,c,this.pinning[a]))}},g.prototype._setMoveBehindKing=function(a,b){var c=this.idx+(b+1)*a;this.canMoveTo(c)&&(this.behindKing=c)},g.prototype._backtrackPinnedMoves=function(a,b,c){var d=this.idx+b*a;c.push(d),d!=this.idx&&this._backtrackPinnedMoves(a,--b,c)},c.Piece=g}),require.define("/King.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Piece").Piece,h=function(a,b,c){this.idx=a,this.color=b,this.board=c,this.type=3,this.moves=[],this.attacks=[],this.behindKing=null,this._castlingIdx=this.color==1?4:116,this._castling=this.color==1?{Q:-1,K:1}:{q:-1,k:1}};h.prototype=new g,h.prototype.calculate=function(){this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this._addRegularMoves(),this._addCastlingMoves()},h.prototype.canCastle=function(a,b){var c=this.idx==this._castlingIdx&&this.board.canCastle(a);return c?!this._pathToRookIsBlocked(a):!1},h.prototype._pathToRookIsBlocked=function(a){return f.find(this.CASTLE_SQUARES[a.toLowerCase()],function(a){var b=this.idx+a;return!this.canMoveTo(b)||this.isAttacked(b)},this)},h.prototype.isAttacked=function(a){return this.board.isAttacked(a)},h.prototype.isProtected=function(a){return this.board.isProtected(a)},h.prototype._addRegularMoves=function(){f.each(this.DIRECTIONS,function(a){var b=this.idx+a;!this.isSquareBehindCheckedKing(b)&&(this.canMoveTo(b)&&!this.isAttacked(b)||this.canCapture(b)&&!this.isProtected(b))&&this.moves.push(b),this.board.isOnBoard(b)&&this.attacks.push(b)},this)},h.prototype.isSquareBehindCheckedKing=function(a){var b=this.board._getCurrentColor();return f.detect(this.board._getPieces(b*-1),function(b){return b.behindKing==a})},h.prototype._addCastlingMoves=function(){f.each(this._castling,function(a,b){this.canCastle(b)&&this.moves.push(this.idx+a*2)},this)},h.prototype.CASTLE_SQUARES={q:[-1,-2,-3],k:[1,2]},h.prototype.DIRECTIONS=[-1,1,15,16,17,-17,-16,-15],c.King=h}),require.define("/Rook.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Piece").Piece,h=function(a,b,c){this.idx=a,this.color=b,this.board=c,this.moves=[]};h.prototype=new g,h.prototype.calculate=function(){this.addDirectionalMoves(this.DIRECTIONS)},h.prototype.DIRECTIONS=[1,-1,16,-16],c.Rook=h}),require.define("/Knight.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Piece").Piece,h=function(a,b,c){this.idx=a,this.color=b,this.board=c,this.moves=[]};h.prototype=new g,h.prototype.calculate=function(){this.moves=[],this.checks=[],this.attacks=[],this.pinning={},this.behindKing=null,this._addRegularMoves(),this._removePinnedMoves(),this._removeMovesNotHelpingCheckedKing()},h.prototype._addRegularMoves=function(){f.each(this.DIRECTIONS,function(a){var b=this.idx+a;(this.canMoveTo(b)||this.canCapture(b))&&this.moves.push(b);if(this.canCapture(b)){var c=this.board._getPieceAt(b);c.color!=this.color&&c.type==3&&(this.checks=[this.idx])}this.board.isOnBoard(b)&&this.attacks.push(b)},this)},h.prototype.DIRECTIONS=[14,18,31,33,-18,-14,-33,-31],c.Knight=h}),require.define("/Bishop.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Piece").Piece,h=function(a,b,c){this.idx=a,this.color=b,this.board=c,this.moves=[]};h.prototype=new g,h.prototype.calculate=function(){this.addDirectionalMoves(this.OFFSETS)},h.prototype.OFFSETS=[15,17,-17,-15],c.Bishop=h}),require.define("/Queen.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Piece").Piece,h=function(a,b,c){this.idx=a,this.color=b,this.board=c,this.moves=[]};h.prototype=new g,h.prototype.calculate=function(){this.addDirectionalMoves(this.OFFSETS)},h.prototype.OFFSETS=[-1,1,15,16,17,-17,-16,-15],c.Queen=h}),require.define("/Board.js",function(a,b,c,d,e){var f=a("underscore"),g=a("./Fen").Fen,h=a("./PieceFactory").PieceFactory,i=function(a){this._fen=new g(a),this._board=new Array(128),f.each(this._fen.pieces,function(a,b){var c=this._posToIdx(b);this._board[c]=h.create(a,c,this)},this),this._state={},this._calculate()};i.prototype={WHITE:1,BLACK:-1,_state:"move",_files:"abcdefgh",move:function(a,b){var c=this._getPiece(a);if(!c)throw"there is no piece to move";if(this._getCurrentColor()!=c.color)throw"cannot move out of order";var d=this._posToIdx(b);if(c.moves.indexOf(d)==-1)throw"illegal move";this._state={};if(c.type==1&&(d<9||d>111)&&c.canMoveTo(d)){this._fen.move(a,b),this._updateArray(a,b);var e=c.color=="1"?"Q":"q";this._board[d]=h.create(e,d,this),this._state.promotion=e,this._calculate()}else if(c&&(c.canCapture(d)||c.canMoveTo(d)))this._fen.enPassant==b&&(this._state.enPassantCapture=b[0]+a[1]),this._fen.move(a,b),this._updateArray(a,b),this._fen.halfmove>=50?this._state.finished="halfmoves":this._calculate();else throw"unable to move from "+a+" to "+b;return this._state.to=b,this._state.from=a,this._state.active=this._fen.activeColor,this._state},getState:function(){return this._state},_posToIdx:function(a){if(!a||typeof a!="string"||!a.match(/[a-h]{1}[0-8]{1}/))throw"illegal pos "+a;var b=this._files.indexOf(a[0]);return b+(a[1]-1)*16},_idxToPos:function(a){var b=a%16,c=Math.floor(a/16),d=this._files[b]+(c+1);if(typeof d!="string")throw"illegal idx "+a;return d},_getPieceAt:function(a){return this._board[a]},_getPieces:function(a){return f.filter(this._board,function(b){return a?b&&b.color==a:b})},_getPiece:function(a){var b=this._posToIdx(a);return this._getPieceAt(b)},_getCurrentColor:function(){return this._fen.activeColor=="w"?this.WHITE:this.BLACK},_calculate:function(){var a=this._getCurrentColor(),b=[],c=[];f.each(this._getPieces(a*-1),function(a){a.calculate(),c=f.union(c,a.attacks)}),f.each(this._getPieces(a),function(a){a.calculate(),b=b.concat(a.moves),a.type==3&&c.indexOf(a.idx)!=-1&&(this._state.check=!0)},this),b.length===0&&(this._state.check?this._state.finished="checkmate":this._state.finished="stalemate")},_updateArray:function(a,b){var c=this._posToIdx(a),d=this._board[c];this._board[c]=null;var e=this._posToIdx(b);d.idx=e,this._board[e]=d},getCheckingPieces:function(){var a=this._getCurrentColor(),b=this._getPieces(a*-1);return f.filter(b,function(a){return a.checks&&a.checks.length>0})},isPinned:function(a){var b=this._getCurrentColor(),c=this._getPieces(b*-1),d=f.detect(c,function(b){return b.pinning&&b.pinning[a]});if(d)return f(d.pinning[a]).chain().clone().without(a).union(d.idx).value()},isAttacked:function(a){var b=this._getCurrentColor();return f.detect(this._getPieces(b*-1),function(b){return b.attacks.indexOf(a)!=-1})},isProtected:function(a){var b=this._getCurrentColor();return f.detect(this._getPieces(b*-1),function(b){return b.moves.indexOf(a)!=-1||b.attacks.indexOf(a)!=-1})},isEmpty:function(a){return!this._getPieceAt(a)},isOnBoard:function(a){return a>=0&&a<127&&(a&136)===0},canCastle:function(a){return this._fen.canCastle(a)},isEnPassant:function(a){var b=this._fen.enPassant;if(b&&b!="-"){var c=this._posToIdx(b);return a==c}return!1},getMoves:function(a){var b=this._posToIdx(a),c=this._getPieceAt(b);return c&&c.color==this._getCurrentColor()?f.map(c.moves,function(a){return this._idxToPos(a)},this):[]}},c.Board=i}),require("/Board.js");